{% comment %}
  Script de détection de langue du navigateur
  Ce script redirige automatiquement l'utilisateur vers la version linguistique appropriée
  basée sur la langue de son navigateur, sauf s'il a déjà visité le site (cookie)
{% endcomment %}

<script>
(function() {
  // Vérifier si l'utilisateur a déjà fait un choix de langue (cookie)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
  }

  const existingChoice = getCookie('lang_choice');
  if (existingChoice) {
    return;
  }

  const userAgent = (navigator.userAgent || '').toLowerCase();
  const isBot = /googlebot|bingbot|slurp|duckduckbot|baiduspider|yandexbot|facebot|ia_archiver/.test(userAgent);

  const currentPath = window.location.pathname;
  const isRootPage = currentPath === '/' || currentPath === '/index.html';
  const isEnglishSection = currentPath.startsWith('/en/');
  const currentLang = isEnglishSection ? 'en' : 'fr';

  if (isBot) {
    setCookie('lang_choice', currentLang, 30);
    return;
  }

  const browserLanguage = (navigator.language || navigator.userLanguage || '').toLowerCase();
  const langCode = browserLanguage.split('-')[0];
  let preferredLang = 'en';
  if (langCode === 'fr') {
    preferredLang = 'fr';
  } else if (langCode === 'en') {
    preferredLang = 'en';
  }

  if (isRootPage && preferredLang !== currentLang) {
    const target = preferredLang === 'fr' ? '/' : '/en/index.html';
    setCookie('lang_choice', preferredLang, 30);
    window.location.href = target;
    return;
  }

  setCookie('lang_choice', currentLang, 30);
})();
</script>
